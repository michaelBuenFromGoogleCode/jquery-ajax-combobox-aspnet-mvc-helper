(function(b){b.ajaxComboBox=function(h,c,a,f){function G(){var c="#"+b(h).attr("id")+" ."+a.p_area_cls;b(c).length==1?b(c+" ."+a.p_del_cls).css("visibility","hidden"):b(c+" ."+a.p_del_cls).css("visibility","visible")}function x(){y++;var c=b("<div></div>").addClass(a.p_area_cls),z=b("<div></div>"),r=b("<div></div>").addClass(a.p_del_cls);b("<img />").attr({alt:f.del_btn,title:f.del_title,src:a.p_del_img1}).mouseover(function(c){b(c.target).attr("src",a.p_del_img2)}).mouseout(function(c){b(c.target).attr("src",
a.p_del_img1)}).click(function(a){var c=a.target,a=b(h).find("input[type=text]").eq(0).attr("id");b(c).parent().parent().remove();c=b(h).find("input[type=text]").eq(0).attr("id");b("label[for="+a+"]").attr("for",c);G()}).appendTo(r);var A=b('<div style="clear:both"></div>');a.packagex?(z.addClass(a.p_acbox_cls),c.append(z).append(r).append(A),b(h).append(c).append(H),z.width(I),b(h).width(I+r.width()),H.css("margin-left",z.width())):(c.append(z),b(h).append(c),z.width(b(h).width()));S(z);G()}function S(c){function h(a){return a.replace(/^.|_./g,
function(a){return a.replace(/_(.)/,"$1").toUpperCase()})}function r(b){var c=B(),b=c&&!b?c.offset().top:s.offset().top,o;a.sub_info?(o=p.children("table:visible"),o=o.height()+parseInt(o.css("border-top-width"),10)+parseInt(o.css("border-bottom-width"),10)):(aa(),o=L);var f=document.documentElement.clientHeight,d=document.documentElement.scrollTop>0?document.documentElement.scrollTop:document.body.scrollTop,e=d+f-o,g;if(c.length)if(b<d||o>f)g=b-d;else if(b>e)g=b-e;else return;else b<d&&(g=b-d);window.scrollBy(0,
g)}function A(){if(a.select_only)if(d.val()!=""){t.val()!=""?(e.attr("title",f.select_ok),e.children("img").attr({src:a.select_ok_img,alt:f.get_all_alt,title:f.select_ok})):(e.attr("title",f.select_ng),e.children("img").attr({src:a.select_ng_img,alt:f.get_all_alt,title:f.select_ng}));return}else t.val("");e.attr("title",f.get_all_btn);e.children("img").attr({src:a.button_img,alt:f.get_all_alt,title:f.get_all_btn})}function x(){U=setTimeout(function(){now_value=d.val();now_value!=J&&(a.select_only&&
(t.val(""),A()),m=1,l=!0,j());J=now_value;x()},500)}function H(){C=setTimeout(function(){M==!1&&u==!1&&v()},500)}function G(b){if(/27$|38$|40$|^9$/.test(b.keyCode)&&w.is(":visible")||/^37$|39$|13$|^9$/.test(b.keyCode)&&B()||/40$/.test(b.keyCode))switch(b.preventDefault&&b.preventDefault(),b.stopPropagation&&b.stopPropagation(),b.cancelBubble=!0,b.returnValue=!1,b.keyCode){case 37:b.shiftKey?ba():ca();break;case 38:D=!0;(b=B())?(E(b.prev()),b.removeClass(a.select_class).prev().addClass(a.select_class)):
(E(g.children("li:last-child"),g.children("li").length-1),g.children("li:last-child").addClass(a.select_class));r();break;case 39:b.shiftKey?da():ea();break;case 40:!w.is(":visible")&&!B()?(l=!1,j()):(D=!0,(b=B())?(E(b.next()),b.removeClass(a.select_class).next().addClass(a.select_class)):(E(g.children("li:first-child"),0),g.children("li:first-child").addClass(a.select_class)),r());break;case 9:N=!0;v();break;case 13:V();break;case 27:N=!0,v()}else x(),t.valid()}function I(){e.children("img").attr("src",
a.button_img);O=!1;W?e.mouseover():e.mouseout()}function fa(){P&&(P.abort(),P=!1,I())}function j(){var c=l?b.trim(d.val()):"",$=l?m:q;l&&c.length<a.minchars?v():(fa(),p.children("table").css("display","none"),O=!0,e.attr("title",f.loading),e.children("img").attr({src:a.load_img,alt:f.loading_alt,title:f.loading}),P=b.post(a.source,{q_word:c,page_num:$,per_page:a.per_page,field:a.field,show_field:a.show_field,hide_field:a.hide_field,select_field:K,order_field:a.order_field,order_by:a.order_by,primary_key:ga,
db_table:a.db_table},function(d){if(d.candidate){d.cnt>d.cnt_page?S(d.cnt,d.cnt_page,$):n.css("display","none");var f=[];b.each(d.candidate,function(b,d){f[b]=d.replace(RegExp(c,"ig"),function(b){return'<span class="'+a.match_class+'">'+b+"</span>"})});var e=[];d.attached?b.each(d.attached,function(a,b){e[a]=b}):e=!1;var T=[];d.primary_key?b.each(d.primary_key,function(a,b){T[a]=b}):T=!1;ha(f,e,T)}else v();I();g.children("li:first-child").addClass(a.select_class);E(g.children("li:first-child"));r(!0)}))}
function S(c,e,g){var k=a.per_page*(g-1)+1,e=f.page_info.replace("cnt",c).replace("num_page_top",k).replace("num_page_end",k+e-1);n.text(e);e=b("<p></p>");c=Math.ceil(c/a.per_page);l?Q=c:R=c;for(var h=g-Math.ceil((a.navi_num-1)/2),k=g+Math.floor((a.navi_num-1)/2);h<1;)h++,k++;for(;k>c;)k--;for(;k-h<a.navi_num-1&&h>1;)h--;g==1?(a.navi_simple||b("<span></span>").text("<< 1").addClass("page_end").appendTo(e),b("<span></span>").text(f.prev).addClass("page_end").appendTo(e)):(a.navi_simple||b("<a></a>").attr({href:"javascript:void(0)",
"class":"navi_first"}).text("<< 1").attr("title",f.first_title).appendTo(e),b("<a></a>").attr({href:"javascript:void(0)","class":"navi_prev"}).text(f.prev).attr("title",f.prev_title).appendTo(e));for(i=h;i<=k;i++)h=i==g?'<span class="current">'+i+"</span>":i,b("<a></a>").attr({href:"javascript:void(0)","class":"navi_page"}).html(h).appendTo(e);g==c?(b("<span></span>").text(f.next).addClass("page_end").appendTo(e),a.navi_simple||b("<span></span>").text(c+" >>").addClass("page_end").appendTo(e)):(b("<a></a>").attr({href:"javascript:void(0)",
"class":"navi_next"}).text(f.next).attr("title",f.next_title).appendTo(e),a.navi_simple||b("<a></a>").attr({href:"javascript:void(0)","class":"navi_last"}).text(c+" >>").attr("title",f.last_title).appendTo(e));c>1&&(n.append(e).show(),b(".navi_first").mouseup(function(a){d.focus();a.preventDefault();ba()}),b(".navi_prev").mouseup(function(a){d.focus();a.preventDefault();ca()}),b(".navi_page").mouseup(function(a){d.focus();a.preventDefault();l?m=parseInt(b(this).text(),10):q=parseInt(b(this).text(),
10);j()}),b(".navi_next").mouseup(function(a){d.focus();a.preventDefault();ea()}),b(".navi_last").mouseup(function(a){d.focus();a.preventDefault();da()}))}function ba(){l?m>1&&(m=1,j()):q>1&&(q=1,j())}function ca(){l?m>1&&(m--,j()):q>1&&(q--,j())}function ea(){l?m<Q&&(m++,j()):q<R&&(q++,j())}function da(){l?m<Q&&(m=Q,j()):q<R&&(q=R,j())}function ha(c,h,o){if(c.length==0)v();else{g.empty();p.empty();for(var k=0;k<c.length;k++){var l=b("<li>"+c[k]+"</li>");a.select_only&&l.attr("id",o[k]);g.append(l);
if(h){for(var l=b("<table><tbody></tbody></table>"),j=0;j<h[k].length;j++){var n=a.sub_as[h[k][j][0]]!=null?a.sub_as[h[k][j][0]]:h[k][j][0],m=b("<tr></tr>");m.append("<th>"+n+"</th>");m.append("<td>"+h[k][j][1]+"</td>");l.children("tbody").append(m)}p.append(l)}}h&&p.insertAfter(g);w.show().width(s.width()+parseInt(s.css("border-left-width"))+parseInt(s.css("border-right-width")));g.children("li").mouseover(function(){D?D=!1:(E(this),g.children("li").removeClass(a.select_class),b(this).addClass(a.select_class))}).mousedown(function(){u=
!0;clearTimeout(C)}).mouseup(function(a){u=!1;D?D=!1:(a.preventDefault(),a.stopPropagation(),V(),d.focus())});e.attr("title",f.close_btn);e.children("img").attr({src:a.load_img,alt:f.close_alt,title:f.close_btn})}}function B(){if(!w.is(":visible"))return!1;var b=g.children("li."+a.select_class);b.length||(b=!1);return b}function V(){r(!0);var b=B();b&&(d.val(b.text()),v(),J=d.val(),a.select_only&&(t.val(b.attr("id")),A()));d.change();t.valid()}function v(){N&&(r(!0),N=!1);w.hide();p.children("table").css("display",
"none");fa();A()}function aa(){L==null&&($obj=g.children("li:first"),L=$obj.height()+parseInt($obj.css("border-top-width"),10)+parseInt($obj.css("border-bottom-width"),10)+parseInt($obj.css("padding-top"),10)+parseInt($obj.css("padding-bottom"),10))}function E(c,d){if(a.sub_info&&(X==null&&(X=parseInt(g.css("border-top-width"),10)),Y==null&&(Y=n.height()+parseInt(n.css("border-top-width"),10)+parseInt(n.css("border-bottom-width"),10)+parseInt(n.css("padding-top"),10)+parseInt(n.css("padding-bottom"),
10)),aa(),Z==null&&(Z=g.width()+parseInt(g.css("padding-left"),10)+parseInt(g.css("padding-right"),10)+parseInt(g.css("border-left-width"),10)+parseInt(g.css("border-right-width"),10)),d==null&&(d=g.children("li").index(c)),p.children("table").css("display","none"),d>-1)){var e=0;n.css("display")!="none"&&(e+=Y);e+=X+L*d;var f=Z;b.browser.mozilla&&(e++,f++);e+="px";f+="px";p.children("table:eq("+d+")").css({position:"absolute",top:e,left:f,display:b.browser.msie?"block":"table"})}}b.ajaxSetup({cache:!1});
var M=!1,C=!1,U=!1,l=!1,q=1,m=1,R=1,Q=1,O=!1,W=!1,u=!1,P=!1,N=!1,D=!1,J="",Y=null,X=null,L=null,Z=null,K;a.sub_info?K=a.show_field&&!a.hide_field?a.field+","+a.show_field:"*":(K=a.field,a.hide_field="");a.select_only&&K!="*"&&(K+=","+a.primary_key);var ga=a.select_only?a.primary_key:"";b(c).addClass(a.combo_class);var s=b('<table cellspacing="1"><tbody><tr><th></th><td></td></tr></tbody></table>').addClass(a.table_class),d=b("<input />").attr({type:"text",autocomplete:"off"}).addClass(a.input_class);
if(a.cake_rule){var F=h(a.cake_field);a.packagex?d.attr({name:"data["+a.cake_model+"]["+a.cake_field+"]["+(y-1)+"]",id:a.cake_model+F+(y-1)}):d.attr({name:"data["+a.cake_model+"]["+a.cake_field+"]",id:a.cake_model+F})}else d.attr({name:"ux_"+a.the_field_name,id:"ux_"+a.the_field_name});var F=s.children("tbody").children("tr").children("th"),e=s.children("tbody").children("tr").children("td");e.append("<img />");var w=b("<div></div>").addClass(a.re_area_class),n=b("<div></div>").addClass(a.navi_class),
g=b("<ul></ul>").addClass(a.results_class),p=b("<div></div>").addClass(a.sub_info_class),t=b('<input type="hidden" />').attr({name:a.the_field_name,id:a.the_field_name}).val("");t.attr(a.other_attr);A();F.append(d);w.append(n).append(g);b(c).append(s).append(w);a.select_only&&b(c).append(t);d.width(b(c).width()-e.children("img").width()-parseInt(F.css("padding-left"))-parseInt(F.css("padding-right"))-parseInt(e.css("padding-left"))-parseInt(e.css("padding-right"))-parseInt(e.css("border-left-width"))-
parseInt(e.css("border-right-width"))-parseInt(s.css("border-left-width"))-parseInt(s.css("border-right-width"))-3);(function(){a.init_val!==!1&&(a.select_only?(t.val(a.init_val[y-1]),b.post(a.init_src,{q_word:a.init_val[y-1],field:a.field,primary_key:a.primary_key,db_table:a.db_table},function(b){d.val(b);J=b;e.attr("title",f.select_ok);e.children("img").attr({src:a.select_ok_img,alt:f.get_all_alt,title:f.select_ok})})):(J=a.init_val[y-1],d.val(a.init_val[y-1])))})();e.mouseup(function(a){w.css("display")==
"none"?(clearInterval(U),l=!1,j(),d.focus()):v();a.stopPropagation()});e.mouseover(function(){W=!0;O||e.css("background-image","url("+a.ac_btn_on_img+")").addClass(a.btn_on_class).removeClass(a.btn_out_class)});e.mouseout(function(){W=!1;O||e.css("background-image","url("+a.ac_btn_out_img+")").addClass(a.btn_out_class).removeClass(a.btn_on_class)});e.mouseout();b.support.checkOn&&b.support.cssFloat?d.keypress(G):d.keydown(G);d.focus(function(){M=!0;x()});d.blur(function(){g.children("li").length==
1&&g.children("li:first").text()==b.trim(d.val())&&V();clearTimeout(U);M=!1;H();A()});d.mousedown(function(a){u=!0;clearTimeout(C);a.stopPropagation()});d.mouseup(function(a){d.focus();u=!1;a.stopPropagation()});n.mousedown(function(a){u=!0;clearTimeout(C);a.stopPropagation()});n.mouseup(function(a){d.focus();u=!1;a.stopPropagation()});p.mousedown(function(a){u=!0;clearTimeout(C);a.stopPropagation()});p.mouseup(function(a){d.focus();u=!1;a.stopPropagation()});b("body").mouseup(function(){clearTimeout(C);
M=!1;v()})}var y=0,I=b(h).width(),H=b("<div></div>").addClass(a.p_add_cls);a.packagex&&b("<img />").attr({alt:f.add_btn,title:f.add_title,src:a.p_add_img1}).mouseover(function(c){b(c.target).attr("src",a.p_add_img2)}).mouseout(function(c){b(c.target).attr("src",a.p_add_img1)}).click(function(){x(h)}).appendTo(H);if(a.init_val===!1)x(h);else{for(i=0;a.init_val.length>i;i++)x(h);a.init_val=!1}};b.fn.ajaxComboBox=function(h,c){if(h){c=b.extend({source:h,db_table:"tbl",img_dir:"/Scripts/acbox/img/",field:"name",
minchars:1,per_page:10,navi_num:5,navi_simple:!1,init_val:!1,init_src:"/TheJson/InitVal/",input_prefix:b(this).attr("id")+"_",the_field_name:b(this).attr("id"),mini:!1,lang:"ja",sub_info:!1,sub_as:{},show_field:"",hide_field:"",select_only:!1,primary_key:"id"},c);c=b.extend({order_field:c.field,order_by:"ASC",packagex:!1,p_del_img1:c.img_dir+"del_out.png",p_del_img2:c.img_dir+"del_over.png",p_add_img1:c.img_dir+"add_out.png",p_add_img2:c.img_dir+"add_over.png",cake_rule:!1,cake_model:c.db_table,cake_field:c.field,
p_area_cls:"box_area"+(c.mini?"_mini":""),p_acbox_cls:"combo_box"+(c.mini?"_mini":""),p_add_cls:"add_area"+(c.mini?"_mini":""),p_del_cls:"del_area"+(c.mini?"_mini":""),combo_class:"ac_combobox_area"+(c.mini?"_mini":""),table_class:"ac_table"+(c.mini?"_mini":""),input_class:"ac_input"+(c.mini?"_mini":""),button_class:"ac_button"+(c.mini?"_mini":""),btn_on_class:"ac_btn_on"+(c.mini?"_mini":""),btn_out_class:"ac_btn_out"+(c.mini?"_mini":""),re_area_class:"ac_result_area"+(c.mini?"_mini":""),navi_class:"ac_navi"+
(c.mini?"_mini":""),results_class:"ac_results"+(c.mini?"_mini":""),select_class:"ac_over"+(c.mini?"_mini":""),match_class:"ac_match"+(c.mini?"_mini":""),sub_info_class:"ac_attached"+(c.mini?"_mini":""),button_img:c.img_dir+"combobox_button"+(c.mini?"_mini":"")+".png",load_img:c.img_dir+"ajax-loader"+(c.mini?"_mini":"")+".gif",select_ok_img:c.img_dir+"select_ok"+(c.mini?"_mini":"")+".png",select_ng_img:c.img_dir+"select_ng"+(c.mini?"_mini":"")+".png",ac_btn_on_img:c.img_dir+"btn_on"+(c.mini?"_mini":
"")+".png",ac_btn_out_img:c.img_dir+"btn_out"+(c.mini?"_mini":"")+".png"},c);switch(c.lang){case "ja":var a={add_btn:"\u8ffd\u52a0\u30dc\u30bf\u30f3",add_title:"\u5165\u529b\u30dc\u30c3\u30af\u30b9\u3092\u8ffd\u52a0\u3057\u307e\u3059",del_btn:"\u524a\u9664\u30dc\u30bf\u30f3",del_title:"\u5165\u529b\u30dc\u30c3\u30af\u30b9\u3092\u524a\u9664\u3057\u307e\u3059",next:"\u6b21\u3078",next_title:"\u6b21\u306e"+c.per_page+"\u4ef6 (\u53f3\u30ad\u30fc)",prev:"\u524d\u3078",prev_title:"\u524d\u306e"+c.per_page+
"\u4ef6 (\u5de6\u30ad\u30fc)",first_title:"\u6700\u521d\u306e\u30da\u30fc\u30b8\u3078 (Shift + \u5de6\u30ad\u30fc)",last_title:"\u6700\u5f8c\u306e\u30da\u30fc\u30b8\u3078 (Shift + \u53f3\u30ad\u30fc)",get_all_btn:"\u5168\u4ef6\u53d6\u5f97 (\u4e0b\u30ad\u30fc)",get_all_alt:"\u753b\u50cf:\u30dc\u30bf\u30f3",close_btn:"\u9589\u3058\u308b (Tab\u30ad\u30fc)",close_alt:"\u753b\u50cf:\u30dc\u30bf\u30f3",loading:"\u30ed\u30fc\u30c9\u4e2d...",loading_alt:"\u753b\u50cf:\u30ed\u30fc\u30c9\u4e2d...",page_info:"num_page_top - num_page_end \u4ef6 (\u5168 cnt \u4ef6)",
select_ng:"\u6ce8\u610f : \u30ea\u30b9\u30c8\u306e\u4e2d\u304b\u3089\u9078\u629e\u3057\u3066\u304f\u3060\u3055\u3044",select_ok:"OK : \u6b63\u3057\u304f\u9078\u629e\u3055\u308c\u307e\u3057\u305f\u3002"};break;case "en":a={add_btn:"Add button",add_title:"add a box",del_btn:"Del button",del_title:"delete a box",next:"Next",next_title:"Next"+c.per_page+" (Right key)",prev:"Prev",prev_title:"Prev"+c.per_page+" (Left key)",first_title:"First (Shift + Left key)",last_title:"Last (Shift + Right key)",get_all_btn:"Get All (Down key)",
get_all_alt:"(button)",close_btn:"Close (Tab key)",close_alt:"(button)",loading:"loading...",loading_alt:"(loading)",page_info:"num_page_top - num_page_end of cnt",select_ng:"Attention : Please choose from among the list.",select_ok:"OK : Correctly selected."};break;case "es":a={add_btn:"Agregar boton",add_title:"Agregar una opcion",del_btn:"Borrar boton",del_title:"Borrar una opcion",next:"Siguiente",next_title:"Proximas "+c.per_page+" (tecla derecha)",prev:"Anterior",prev_title:"Anteriores "+c.per_page+
" (tecla izquierda)",first_title:"Primera (Shift + Left)",last_title:"Ultima (Shift + Right)",get_all_btn:"Ver todos (tecla abajo)",get_all_alt:"(boton)",close_btn:"Cerrar (tecla TAB)",close_alt:"(boton)",loading:"Cargando...",loading_alt:"(Cargando)",page_info:"num_page_top - num_page_end de cnt",select_ng:"Atencion: Elija una opcion de la lista.",select_ok:"OK: Correctamente seleccionado."}}this.each(function(){new b.ajaxComboBox(this,h,c,a)});return this}}})(jQuery);